---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: vault-raft-backup
  namespace: vault-hashicorp
  labels:
    app.kubernetes.io/name: vault-raft-backup
    app.kubernetes.io/part-of: vault-raft-operator
    app.kubernetes.io/component: backup
spec:
  # Daily at 2 AM UTC
  schedule: "0 2 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  suspend: false
  jobTemplate:
    metadata:
      labels:
        app.kubernetes.io/name: vault-raft-backup
        app.kubernetes.io/part-of: vault-raft-operator
        app.kubernetes.io/component: backup
    spec:
      backoffLimit: 2
      template:
        metadata:
          labels:
            app.kubernetes.io/name: vault-raft-backup
            app.kubernetes.io/part-of: vault-raft-operator
            app.kubernetes.io/component: backup
        spec:
          automountServiceAccountToken: true
          serviceAccountName: vault-raft-operator-sa
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            seccompProfile:
              type: RuntimeDefault
          volumes:
            - name: tmp-data
              emptyDir: {}
          containers:
            - name: operator
              image: chapsvision/vault-raft-backup-operator:latest
              args: ["backup"]
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop: ["ALL"]
              resources:
                requests:
                  cpu: "100m"
                  memory: "256Mi"
                  ephemeral-storage: "256Mi"
                limits:
                  cpu: "500m"
                  memory: "512Mi"
                  ephemeral-storage: "1Gi"
              volumeMounts:
                - name: tmp-data
                  mountPath: /data
              env:
                # Vault (Kubernetes auth)
                - name: VAULT_ADDR
                  value: "http://vault.vault-hashicorp.svc:8200"
                - name: VAULT_AUTH_METHOD
                  value: "kubernetes"
                - name: VAULT_K8S_MOUNT
                  value: "kubernetes"
                - name: VAULT_K8S_ROLE
                  value: "vault-raft-operator"
                # Provider (Azure)
                - name: BACKUP_PROVIDER
                  value: "azure"
                - name: AZURE_STORAGE_ACCOUNT
                  value: "mystorageaccount"
                - name: AZURE_STORAGE_CONTAINER
                  value: "vault-snapshots"
                # Backup config
                - name: BACKUP_SOURCE
                  value: "/data/snapshot.snap"
                - name: BACKUP_TARGET
                  value: "snapshots"
                # Logs
                - name: LOG_LEVEL
                  value: "info"
                - name: LOG_FORMAT
                  value: "json"
              envFrom:
                - secretRef:
                    name: azure-sp-creds
